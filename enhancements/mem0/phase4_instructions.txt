================================================================================
PHASE 4: AGENT MODIFICATIONS
================================================================================

STEP 4.1: UPDATE MEMORY MANAGER AGENT
--------------------------------------
TASK: Simplify Memory Manager Agent to use Mem0

ACTIONS:
1. Open agents/memory_manager_agent.py

2. Update imports:
   - Add: from services.mem0_service import Mem0Service
   - Remove: from services.vector_service import VectorService

3. Update __init__ method:
   - Initialize Mem0Service instance
   - Keep DatabaseService instance (for metadata)
   - Remove VectorService initialization

4. Simplify execute() method logic:
   
   OLD FLOW:
   - Analyze conversation with LLM
   - Extract memories using complex prompts
   - Calculate importance scores
   - Check for duplicates
   - Consolidate similar memories
   - Store in both SQLite and ChromaDB
   
   NEW FLOW:
   - Analyze conversation with LLM (simplified prompt)
   - Format conversation for Mem0
   - Call Mem0Service.add_memory() with conversation context
   - Mem0 handles extraction, deduplication, scoring automatically
   - Store metadata linkage in SQLite via DatabaseService
   - Return simplified result

5. Update _extract_entities() method:
   - Simplify to basic entity extraction
   - Let Mem0 handle complex extraction

6. Remove methods (no longer needed):
   - _calculate_importance() - Mem0 does this
   - _check_for_updates() - Mem0 does this
   - _consolidate_memories() - Mem0 does this

7. Add new method: _format_for_mem0()
   - Formats conversation history for Mem0 API
   - Includes user message and assistant response
   - Adds metadata (session_id, timestamp)

8. Update prompt templates:
   - Simplify memory extraction prompt
   - Focus on identifying WHAT to remember, not HOW
   - Let Mem0 handle the extraction details

9. Update error handling:
   - Handle Mem0Service errors
   - Fallback behavior if Mem0 fails
   - Log all operations

10. Update logging:
    - Log Mem0 operations
    - Track memories created via Mem0
    - Log any Mem0 errors

CHECKPOINT 4.1:
□ Memory Manager Agent updated
□ Mem0Service integrated
□ Logic simplified significantly
□ Old complex methods removed
□ New format method added
□ Error handling updated
□ Logging updated

---

STEP 4.2: UPDATE MEMORY RETRIEVAL AGENT
----------------------------------------
TASK: Simplify Memory Retrieval Agent to use Mem0

ACTIONS:
1. Open agents/memory_retrieval_agent.py

2. Update imports:
   - Add: from services.mem0_service import Mem0Service
   - Remove: from services.vector_service import VectorService

3. Update __init__ method:
   - Initialize Mem0Service instance
   - Keep DatabaseService instance (for metadata)
   - Remove VectorService initialization

4. Simplify execute() method logic:
   
   OLD FLOW:
   - Understand query intent with LLM
   - Run semantic search in ChromaDB
   - Run keyword search in SQLite
   - Run temporal search
   - Combine results
   - Rank by custom scoring algorithm
   - Format context
   
   NEW FLOW:
   - Prepare query for Mem0
   - Call Mem0Service.search_memories() with query
   - Mem0 handles hybrid search automatically
   - Mem0 provides relevance scoring
   - Format results for conversation agent
   - Return memory context

5. Remove search strategy methods (Mem0 handles these):
   - _semantic_search()
   - _keyword_search()
   - _temporal_search()
   - _entity_search()
   - _hybrid_search()

6. Simplify _calculate_relevance_score():
   - Use Mem0's provided relevance scores
   - Optionally add minor adjustments based on recency
   - Much simpler than before

7. Update _build_memory_context():
   - Format Mem0 results for Conversation Agent
   - Group related memories (Mem0 provides relationships)
   - Add temporal context
   - Simpler formatting

8. Add method: _enrich_with_metadata()
   - Fetches additional metadata from DatabaseService
   - Adds tags, memory_type from memories_metadata table
   - Enriches Mem0 results with local metadata

9. Update error handling:
   - Handle empty search results
   - Handle Mem0Service errors
   - Graceful degradation

10. Update logging:
    - Log search queries
    - Log number of memories retrieved
    - Log Mem0 operations

CHECKPOINT 4.2:
□ Memory Retrieval Agent updated
□ Mem0Service integrated
□ Search methods simplified
□ Complex ranking removed (using Mem0's)
□ Context building simplified
□ Metadata enrichment added
□ Error handling updated
□ Logging updated

---

STEP 4.3: UPDATE CONTEXT COORDINATOR AGENT
-------------------------------------------
TASK: Update orchestration to use new agent implementations

ACTIONS:
1. Open agents/context_coordinator_agent.py

2. No import changes needed (agents remain the same classes)

3. Update execute() method orchestration flow:
   - Keep the same agent calling sequence
   - Memory Manager and Retrieval agents now faster (using Mem0)
   - No logic changes needed in coordinator
   - Just verify error handling covers new Mem0 errors

4. Update error handling in agent execution:
   - Add specific handling for Mem0 errors
   - If Mem0Service fails in Memory Manager: log warning, continue
   - If Mem0Service fails in Memory Retrieval: use empty memory context
   - Don't let Mem0 failures break conversation flow

5. Update fallback strategies:
   - If Mem0 unavailable: operate without memories (like incognito mode)
   - Log degraded operation mode
   - Continue conversation

6. Update token budget management:
   - Mem0 operations may use fewer tokens
   - Update estimates if tracking token budgets
   - Memory Manager agent will use fewer tokens (simpler prompts)

7. Update result aggregation:
   - Ensure Mem0 memory IDs are included in metadata
   - Pass Mem0 results through to API responses
   - Include Mem0 operation status in metadata

8. Update logging:
   - Log when using Mem0 for operations
   - Track Mem0 performance
   - Monitor Mem0 success rates

CHECKPOINT 4.3:
□ Context Coordinator updated
□ Orchestration flow adjusted
□ Error handling for Mem0 added
□ Fallback strategies updated
□ Token management adjusted
□ Logging updated
□ Metadata includes Mem0 info

---

STEP 4.4: VERIFY OTHER AGENTS (NO CHANGES NEEDED)
--------------------------------------------------
TASK: Confirm other agents don't need modifications

ACTIONS:
1. Review agents/conversation_agent.py:
   - Receives memory context from Memory Retrieval Agent
   - Format is same (just source changed to Mem0)
   - No changes needed
   - Verify logging mentions Mem0 when applicable

2. Review agents/privacy_guardian_agent.py:
   - Operates independently of memory system
   - No changes needed
   - Still blocks memory operations in incognito mode
   - Verify privacy mode checks still work

3. Review agents/conversation_analyst_agent.py:
   - Analyzes conversations, not memories directly
   - No changes needed
   - May receive different memory patterns (from Mem0)
   - No code changes required

4. Update agent documentation:
   - Update comments mentioning "ChromaDB" to "Mem0"
   - Update docstrings referencing vector database
   - Update architecture diagrams if embedded in code

CHECKPOINT 4.4:
□ Conversation Agent verified (no changes)
□ Privacy Guardian verified (no changes)
□ Analyst Agent verified (no changes)
□ Documentation updated
□ Comments referring to old system updated

VERIFICATION CHECKPOINT 4:
==========================
□ Memory Manager Agent simplified
□ Memory Retrieval Agent simplified
□ Context Coordinator updated
□ Other agents verified
□ All agents using Mem0 correctly
□ Error handling comprehensive
□ Ready for API updates

